<!DOCTYPE html>
<html>
<head>
    <title>Embed API Demo</title>
    <meta name="google-signin-client_id" content="533408969378-ue74g5a1epbu0o3cm57pvcvc0764qcb1.apps.googleusercontent.com">
    <meta name="google-signin-scope" content="https://www.googleapis.com/auth/analytics.readonly">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-190003462-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-190003462-1');
    </script>
</head>
<body>

<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="https://code.highcharts.com/maps/modules/data.js"></script>
<script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
<script src="https://code.highcharts.com/maps/modules/offline-exporting.js"></script>
<script src="https://code.highcharts.com/mapdata/custom/world.js"></script>

<!-- Step 1: Create the containing elements. -->

<section id="auth-button"></section>
<section id="view-selector"></section>

<link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<div id="container">
    <div class="loading">
        <i class="icon-spinner icon-spin icon-large"></i>
        Loading data from Google Spreadsheets...
    </div>
</div>

<div id="container-daily"></div>

<div id="container-browsers"></div>

<!-- The Sign-in button. This will run `queryReports()` on success. -->
<p class="g-signin2" data-onsuccess="queryReports"></p>

<!-- Step 2: Load the library. -->

<script>
    (function(w,d,s,g,js,fjs){
        g=w.gapi||(w.gapi={});g.analytics={q:[],ready:function(cb){this.q.push(cb)}};
        js=d.createElement(s);fjs=d.getElementsByTagName(s)[0];
        js.src='https://apis.google.com/js/platform.js';
        fjs.parentNode.insertBefore(js,fjs);js.onload=function(){g.load('analytics')};
    }(window,document,'script'));
</script>

<script>
    gapi.analytics.ready(function() {

        // init

        // Step 3: Authorize the user.

        var CLIENT_ID = '533408969378-ue74g5a1epbu0o3cm57pvcvc0764qcb1.apps.googleusercontent.com';

        gapi.analytics.auth.authorize({
            container: 'auth-button',
            clientid: CLIENT_ID,
        });

        // Step 4: Create the view selector.

        var viewSelector = new gapi.analytics.ViewSelector({
            container: 'view-selector'
        });

        // Step 6: Hook up the components to work together.

        gapi.analytics.auth.on('success', function(response) {
            viewSelector.execute();
        });

        viewSelector.on('change', function(ids) {
            var newIds = {
                query: {
                    ids: ids
                }
            }
            console.log(newIds);
            // var viewIdGa = newIds.query.ids;
            // var viewIdValue = viewIdGa.str.replace("ga:", "");
            var viewId = newIds.query.ids.replace("ga:", "");
            console.log(viewId);

            // Replace with your view ID.
            var VIEW_ID = viewId;

            // Display circle diagram browsers and number of visits statistics
            function queryCircle() {
                gapi.client.request({
                    path: '/v4/reports:batchGet',
                    root: 'https://analyticsreporting.googleapis.com/',
                    method: 'POST',
                    body: {
                        reportRequests: [
                            {
                                viewId: VIEW_ID,
                                "metrics":[
                                    {
                                        "expression":"ga:sessions"
                                    }],
                                "dimensions": [
                                    {
                                        "name":"ga:browser"
                                    }]
                            }
                        ]
                    }
                }).then(circleDiagramData, console.error.bind(console));
            }
            function circleDiagramData(response) {
                console.log(response);
                var totals = response.result.reports[0].data.totals[0].values[0];
                var data = [];
                response.result.reports[0].data.rows.forEach(function(item){
                    console.log(item);
                    var dataObject = {
                        name: item.dimensions[0],
                        y: ((item.metrics[0].values[0]) * 100)/totals
                    }
                    data.push(dataObject);
                });
                console.log(data);

                // Build the chart
                Highcharts.chart('container-browsers', {
                    chart: {
                        plotBackgroundColor: null,
                        plotBorderWidth: null,
                        plotShadow: false,
                        type: 'pie'
                    },
                    title: {
                        text: 'Number of sessions by browser'
                    },
                    tooltip: {
                        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                    },
                    accessibility: {
                        point: {
                            valueSuffix: '%'
                        }
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            dataLabels: {
                                enabled: false
                            },
                            showInLegend: true
                        }
                    },
                    series: [{
                        name: 'Browsers',
                        colorByPoint: true,
                        data: data
                    }]
                });
            }
            queryCircle();


            // Display map diagram number of visits by countries
            function queryMap() {
                gapi.client.request({
                    path: '/v4/reports:batchGet',
                    root: 'https://analyticsreporting.googleapis.com/',
                    method: 'POST',
                    body: {
                        reportRequests: [
                            {
                                viewId: VIEW_ID,
                                "dimensions": [
                                    {
                                        "name":"ga:country"
                                    },
                                    {
                                        "name":"ga:countryIsoCode"
                                    }]
                            }
                        ]
                    }
                }).then(mapDiagramData, console.error.bind(console));
            }
            function mapDiagramData(response) {
                console.log(response);
                var data = [];
                response.result.reports[0].data.rows.forEach(function(item){
                    console.log(item);
                    var dataObject = {
                        code: item.dimensions[1],
                        value: item.metrics[0].values[0],
                        name: item.dimensions[0]
                    }
                    data.push(dataObject);
                });
                console.log("maps data",data);

                Highcharts.mapChart('container', {
                    chart: {
                        map: 'custom/world',
                        borderWidth: 1
                    },

                    colors: ['rgba(19,64,117,0.05)', 'rgba(19,64,117,0.2)', 'rgba(19,64,117,0.4)',
                        'rgba(19,64,117,0.5)', 'rgba(19,64,117,0.6)', 'rgba(19,64,117,0.8)', 'rgba(19,64,117,1)'],

                    title: {
                        text: 'Number of sessions per country'
                    },

                    mapNavigation: {
                        enabled: true
                    },

                    legend: {
                        title: {
                            text: 'Number of sessions per country',
                            style: {
                                color: ( // theme
                                    Highcharts.defaultOptions &&
                                    Highcharts.defaultOptions.legend &&
                                    Highcharts.defaultOptions.legend.title &&
                                    Highcharts.defaultOptions.legend.title.style &&
                                    Highcharts.defaultOptions.legend.title.style.color
                                ) || 'black'
                            }
                        },
                        align: 'left',
                        verticalAlign: 'bottom',
                        floating: true,
                        layout: 'vertical',
                        valueDecimals: 0,
                        backgroundColor: ( // theme
                            Highcharts.defaultOptions &&
                            Highcharts.defaultOptions.legend &&
                            Highcharts.defaultOptions.legend.backgroundColor
                        ) || 'rgba(255, 255, 255, 0.85)',
                        symbolRadius: 0,
                        symbolHeight: 14
                    },

                    colorAxis: {
                        dataClasses: [{
                            to: 3
                        }, {
                            from: 3,
                            to: 10
                        }, {
                            from: 10,
                            to: 30
                        }, {
                            from: 30,
                            to: 100
                        }, {
                            from: 100,
                            to: 300
                        }, {
                            from: 300,
                            to: 1000
                        }, {
                            from: 1000
                        }]
                    },

                    series: [{
                        data: data,
                        joinBy: ['iso-a2', 'code'],
                        animation: true,
                        name: 'Numbers of users',
                        states: {
                            hover: {
                                color: '#a4edba'
                            }
                        },
                        shadow: false
                    }]
                });
            }
            queryMap();

            // Display circle diagram browsers and number of visits statistics
            function queryDailyVisits() {
                gapi.client.request({
                    path: '/v4/reports:batchGet',
                    root: 'https://analyticsreporting.googleapis.com/',
                    method: 'POST',
                    body: {
                        reportRequests: [{
                            dateRanges: [
                                {
                                    startDate: '30daysAgo',
                                    endDate: 'today'
                                }
                            ],
                            viewId: VIEW_ID,
                            metrics: [{ expression: "ga:users" }],
                            dimensions: [{ name: "ga:pagePath" }, {name: 'ga:date'}]
                        }]
                    }
                }).then(dailyVisitsDiagramData, console.error.bind(console));
            }
            function dailyVisitsDiagramData(response) {
                console.log("daily",response);
                var start = response.result.reports[0].data.rows[0].dimensions[1];
                var data = [];
                var startDate = response.result.reports[0].data.rows[0].dimensions[1];
                response.result.reports[0].data.rows.forEach(function(item){
                    console.log(item);
                    console.log("item dimensions",item.dimensions[1]);
                    data.push(item.metrics[0].values[0] * 1);
                    // if(item.dimensions[1] == startDate) {
                    //     data.push(item.metrics[0].values[0] * 1);
                    // } else {
                    //     data.push(0);
                    // }
                    var year = startDate.substring(0, 4);
                    var month = startDate.substring(4, 6);
                    var day = startDate.substring(6, 8);

                    var displayDate = year + '-' + month + '-' + day;

                    date = new Date(displayDate);
                    console.log("date", date);
                });
                console.log(data);

                // Build the chart
                Highcharts.chart('container-daily', {

                    title: {
                        text: 'Number Of Users'
                    },

                    yAxis: {
                        title: {
                            text: 'Number of Sessions'
                        }
                    },
                    xAxis: {
                        type: 'datetime'
                    },

                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle'
                    },

                    plotOptions: {
                        series: {
                            lineWidth: 4,
                            states: {
                                hover: {
                                    lineWidth: 5
                                }
                            },
                            marker: {
                                enabled: true
                            },
                            pointInterval: 3600000*24, // one day
                            pointStart: Date.UTC(2018, 1, 13, 0, 0, 0)
                        }
                    },

                    series: [{
                        data: data
                    }],

                    responsive: {
                        rules: [{
                            condition: {
                                maxWidth: 500
                            },
                            chartOptions: {
                                legend: {
                                    layout: 'horizontal',
                                    align: 'center',
                                    verticalAlign: 'bottom'
                                }
                            }
                        }]
                    }

                });
            }
            queryDailyVisits();

        });
    });

</script>

<!-- The API response will be printed here. -->
<textarea style="display:block;" cols="80" rows="20" id="query-output"></textarea>

<!-- Load the JavaScript API client and Sign-in library. -->
<script src="https://apis.google.com/js/client:platform.js"></script>

</body>
</html>